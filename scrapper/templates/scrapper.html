<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consulta por CPF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
       .label {
            font-weight: 600;
            color: #555;
        }
        .value {
            font-weight: 500;
        }
        .bank-img{
            border-radius: 5px;
            max-height: 28px;
            max-width: 50px;
        }
        #bank-756{
            background-color: rgb(69, 69, 241);
        }
        #bank-707{
            background-color: rgb(0, 0, 129);
        }
        .darken {
            filter: grayscale(100%) brightness(10%);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bank-img {
            transition: 0.3s;
        }

        .bank-img.clickable {
            cursor: pointer;
        }

        .bank-img.clickable:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>

<div class="container my-5">

    <h3 class="mb-4">Consulta de Benefícios por CPF</h3>

    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" id="cpf" class="form-control" placeholder="Digite o CPF">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="consultar()">Consultar</button>
        </div>
    </div>

    <div id="status" class="mb-3"></div>

    <div id="resultado">

    </div>

</div>

<div class="modal fade" id="tablesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tablesModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-sm table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>Tabela</th>
              <th>Prazo</th>
              <th>Coeficiente</th>
              <th>Troco</th>
            </tr>
          </thead>
          <tbody id="tablesModalBody"></tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="tablesPortModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tablesPortModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="tablesPortModalBody"></div>
    </div>
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>

window.addEventListener('load', async () => {
  await loginAndSaveToken()
})



async function loginAndSaveToken() {
  try {
    const response = await fetch(
      'https://expertconsig.pythonanywhere.com/api/v1/authentication/token/',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: 'scrapper',
          password: 'Vanguard@20'
        })
      }
    )

    const data = await response.json()

    if (!response.ok) {
      return {
        status: 'error',
        code: response.status,
        data
      }
    }

    localStorage.setItem('access', data.access)
    localStorage.setItem('refresh', data.refresh)

    return {
      status: 'success',
      access: data.access,
      refresh: data.refresh
    }

  } catch (error) {
    return {
      status: 'error',
      message: 'Erro ao conectar com o servidor'
    }
  }
}


function consultar() {
    const cpf = document.getElementById("cpf").value.trim();
    const status = document.getElementById("status");
    const resultado = document.getElementById("resultado");

    status.innerHTML = "";
    resultado.innerHTML = "";

    if (!cpf) {
        status.innerHTML = `<div class="alert alert-danger">Informe um CPF</div>`;
        return;
    }

    status.innerHTML = `
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    `;

    fetch("{% url 'scrapper' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ cpf })
    })
    .then(res => res.json())
    .then(data => {

        if (data.erro) {
            status.innerHTML = `<div class="alert alert-danger">${data.erro}</div>`;
            return;
        }

        status.innerHTML = `<div></div>`;
        renderResultado(data);
    })
    .catch(() => {
        status.innerHTML = `<div class="alert alert-danger">Erro ao consultar</div>`;
    });
}


function maskCPF(cpf) {
    const cpfNumbers = String(cpf).replace(/\D/g, '');

    const cpfPadded = cpfNumbers
        .padStart(11, '0')
        .slice(-11);

    return cpfPadded.replace(
        /(\d{3})(\d{3})(\d{3})(\d{2})/,
        '$1.$2.$3-$4'
    );
}


function maskCEP(cep) {
    const cepNumbers = String(cep).replace(/\D/g, '');

    const cepPadded = cepNumbers
        .padStart(8, '0')
        .slice(-8);

    return cepPadded.replace(
        /(\d{5})(\d{3})/,
        '$1-$2'
    );
}


async function renderResultado(data) {
    let result = document.getElementById("resultado");
    result.innerHTML = "";

    for (let index = 0; index < data.length; index++) {
        const element = data[index];
        let installmentHTML = "";
        const collapseId = `collapse-${index}`;

        const nb_data = {
            age: ageHandler(element.nascimento),
            entity_code: entityHandler(element.especie),
            initial_date: convertToISODate(element.ddb),
        };

        if (element["empréstimos"] && element["empréstimos"].length) {
            for (const installment of element["empréstimos"]) {
                installmentHTML += await renderInstallments(installment, nb_data);
            }
        }

        html = `
            <div class="accordion-item rounded shadow-sm p-3 mt-2 bg-success-subtle" id="index-id-${index}">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#${collapseId}"
                        data-index="${index}"
                        aria-expanded="false"
                        aria-controls="${collapseId}">
                        <div class="col-md-6">
                            <span class="label">Matrícula: ${element.nb_uf}</span>
                        </div>
                        <div class="col-md-6">
                            <span class="label" id="especie-${index}">${element.especie}</span>
                        </div>
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse mt-2 bg-light rounded">
                    <div class="row g-3 ms-2 mt-1 text-center">
                        <div class="col-md-4">
                            <label class="label">Nome</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.nome}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">CPF</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.cpf}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Nascimento</label>
                            <input class="text-muted form-control form-control-sm text-center" id="nascimento-${index}" disabled value="${element.nascimento}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Matrícula</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.nb_uf}" type="text">
                        </div>
                    </div>
                    <div class="row g-3 ms-2 mt-1 text-center">
                        <div class="col-md-2">
                            <label class="label">Situação</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.situacao_beneficio}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Data de Despacho</label>
                            <input class="text-muted form-control form-control-sm text-center" id="data_despacho-${index}" disabled value="${element.ddb}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Recebimento</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.meio_pagamento}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Salário</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.base_calculo}" type="text">
                        </div>
                        <div class="col-md-1">
                            <label class="label">Banco</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.banco}" type="text">
                        </div>
                        <div class="col-md-1">
                            <label class="label">Agência</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.agencia}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Conta</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.conta_corrente}" type="text">
                        </div>
                    </div>

                    <div class="row g-3 ms-2 text-center mt-2">
                        <div class="col-md-4">
                            <label class="label">Endereço</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.endereco}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">CEP</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${maskCEP(element.cep)}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Bairro</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.bairro}" type="text">
                        </div>
                        <div class="col-md-3">
                            <label class="label">Cidade UF</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.cidade_uf}" type="text">
                        </div>
                    </div>

                    <div class="row ms-1 me-1 mt-4">
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">Margem Livre</span> <span id="margem-${index}" class="text-muted">${element.margem_35}</span></div>
                                <div class="card-body" id="margem-div-${index}"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">RMC</span> <span id="rmc-${index}" class="text-muted">${element.margem_cartao}</span></div>
                                <div class="card-body" id="rmc-div-${index}"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">RCC</span> <span id="rcc-${index}" class="text-muted">${element.cartao_beneficio}</span></div>
                                <div class="card-body" id="rcc-div-${index}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 m-1">
                        <div class="card">
                            <div class="card-header">
                                <div class="row text-center">
                                    <div class="col-2"><span class="label">Contrato</span></div>
                                    <div class="col-2"><span class="label">Banco</span></div>
                                    <div class="col-2"><span class="label">Parcela</span></div>
                                    <div class="col-2"><span class="label">Saldo</span></div>
                                    <div class="col-2"><span class="label">Prazo</span></div>
                                    <div class="col-2"><span class="label">Taxa</span></div>
                                </div>
                            </div>
                            <div class="card-body">
                                ${installmentHTML || "<div class='text-center text-muted'>Nenhum empréstimo</div>"}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
        `
        result.innerHTML += html;

    document.querySelectorAll('.accordion-button').forEach(button => {
        button.addEventListener('click', async function () {
            const index = this.dataset.index;
            const div = document.getElementById(`margem-div-${index}`);
            if (div.dataset.loaded === "true") return;
            await getMargemLivre(index);
            div.dataset.loaded = "true";
        });
    });
}
}


function renderBanks(results) {
    return `
        <div class="d-flex justify-content-center gap-2 flex-wrap">
            ${results.map((bank, idx) => {
                const hasTables = Array.isArray(bank.result);

                return `
                    <img 
                        src="${bank.icon}"
                        id="bank-${bank.bank}"
                        alt="${bank.bank_name}"
                        title="${hasTables ? 'Ver tabelas' : bank.result}"
                        class="bank-img ${!hasTables ? 'darken' : 'clickable'}"
                        data-index="${idx}" 
                        onclick='openTablesPortModal(
                            "${bank.bank_name}",
                            ${JSON.stringify(bank.result)}
                        )'

                    />
                `;
            }).join("")}
        </div>
    `;
}


async function renderInstallments(element, nb_data){
    if (element.taxa === "1,50%"){
        const installment = Number(element.parcela.replace(".", "").replace(",", "."));
        const rate = 0.0170;
        const terms = Number(element.prazo.split("/")[0]);
        const newBallance = getBallance(installment, rate, terms);
        element.taxa = "1,70%";
        element.saldo_devedor = Number(newBallance).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    payload = {
        age: nb_data.age,
        entity_code: nb_data.entity_code,
        illiterate: false,
        negative: false,
        user_room: 1,
        initial_date: nb_data.initial_date,
        original_bank: parseInt(bankHandler(element.banco).split("-")[1].trim()),
        taxa: parseFloat(element.taxa.replace("%", "").replace(",", ".")),
        prazo_original: parseInt(element.prazo.split("/")[1].split("|")[0]),
        prazo_restante: parseInt(element.prazo.split("/")[0]),
        installment: parseFloat(element.parcela.replace(".", "").replace(",", ".")),
        ballance: parseFloat(element.saldo_devedor.replace(".", "").replace(",", ".")),
    }

    const response = await getPortOperations(payload);

    return `
    <div class="row text-center py-1 mb-1">
        <div class="col-2"><strong class="text-dark">${element.contrato}</strong></div>
        <div class="col-2"><strong class="text-dark"><span>${bankHandler(element.banco)}</span></strong></div>
        <div class="col-2"><strong class="text-dark">R$ <span>${element.parcela}</span></strong></div>
        <div class="col-2"><strong class="text-dark">R$ <span>${element.saldo_devedor}</span></strong></div>
        <div class="col-2"><strong class="text-dark"><span>${element.prazo}</span></strong></div>
        <div class="col-2"><strong class="text-dark"><span>${element.taxa}</span></strong></div>
    </div>
    <div class="row text-center border-bottom py-2 mb-2">
        <div class="col-12">
            ${response?.results?.length ? renderBanks(response.results) : ""}
        </div>
    </div>
    `
}


function openTablesModal(index) {
    document.getElementById("tablesModalTitle").innerHTML = `
        <img src="${bank.icon}" width="30" class="me-2">
        ${bank.bank_name}
    `;

    document.getElementById("tablesModalBody").innerHTML = `
        <table class="table table-sm table-hover text-center align-middle">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Coeficiente</th>
                    <th>Troco</th>
                    <th>Prazo</th>
                </tr>
            </thead>
            <tbody>
                ${bank.result.map(table => `
                    <tr>
                        <td>${table.name}</td>
                        <td>${table.coefficient}</td>
                        <td>R$ ${table.exchange.toFixed(2)}</td>
                        <td>${table.terms}</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;

    new bootstrap.Modal(document.getElementById("tablesModal")).show();
}


function bankHandler(text){
    return text.split(":")[1].trim();
}


function getBallance(installment, rate, remainingTerms) {
    return Number((installment / rate) * (1 - (1 + rate) ** - remainingTerms))
}


function getRate(amountFinanced, installment, terms) {
    const precision = 0.00001;
    let minRate = 0.01;
    let maxRate = 0.04;
    const maxIterations = 1000;
    const defaultValue = 0.01;

    for (let iter = 0; iter < maxIterations; iter++) {
        const rate = (minRate + maxRate) / 2;
        let futureAmount = amountFinanced;
        for (let t = 0; t < terms; t++) {
        futureAmount = futureAmount * (1 + rate) - installment;
        }
        if (Math.abs(futureAmount) < precision) {
        return rate;
        }
        if (futureAmount > 0) {
        maxRate = rate;
        } else {
        minRate = rate;
        }
    }
    return defaultValue;
}


function ageHandler(text){
    return Number(text.split("-")[1].replace("anos", "").trim());
}


function convertToISODate(dateBR) {
  if (!dateBR) return null

  const [day, month, year] = dateBR.split('/')

  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`
}


function floatValueHandler(text){
    return Number(text.replace("R$", "").replace(".", "").replace(",", "."));
}


function entityHandler(text){
    return Number(text.split("-")[0].trim());
}


async function getMargemLivre(index){
    margemValue = document.getElementById(`margem-${index}`).textContent;
    divResult = document.getElementById(`margem-div-${index}`);

    payload = {
        age: ageHandler(document.getElementById(`nascimento-${index}`).value),
        installment: floatValueHandler(document.getElementById(`margem-${index}`).textContent),
        entity_code: entityHandler(document.getElementById(`especie-${index}`).textContent),
        illiterate: false,
        negative: false,
        user_room: 1,
        initial_date: convertToISODate(document.getElementById(`data_despacho-${index}`).value),
    }

    const response = await getNewOperations(payload);

    const banks = response.results;

    let html = `<div class="row g-2">`;

    banks.forEach(bank => {
        const hasTables = Array.isArray(bank.result);
        if (Array.isArray(bank.result)) {
            bank.result.reverse()
        }

        const hasError = typeof bank.result === 'string'

        html += `
            <div class="col-12 col-md-6 col-lg-4 text-center">
                <img 
                    class="bank-img ${hasError ? 'darken' : ''}"
                    id="bank-${index}-${bank.bank}"
                    src="${bank.icon}"
                    alt="${bank.bank_name}"
                    title="${hasError ? bank.result : 'Clique para ver tabelas'}"
                    style="cursor: ${hasTables ? 'pointer' : 'not-allowed'};"
                    ${hasTables ? `
                        onclick='openTablesModal(
                            "${bank.bank_name}",
                            ${JSON.stringify(bank.result)}
                        )'
                    ` : ''}
                />
            </div>
        `
    })

    html += `</div>`;
    divResult.innerHTML = html;
}


function openTablesPortModal(bankName, tables) {
    document.getElementById("tablesPortModalTitle").innerText = bankName;

    document.getElementById("tablesPortModalBody").innerHTML = `
        <table class="table table-sm table-hover text-center align-middle">
            <thead>
                <tr>
                    <th>Tabela</th>
                    <th>Prazo</th>
                    <th>Coeficiente</th>
                    <th>Troco</th>
                </tr>
            </thead>
            <tbody>
                ${tables.map(table => `
                    <tr>
                        <td>${table.name}</td>
                        <td>${table.terms}</td>
                        <td>${table.coefficient.toFixed(6)}</td>
                        <td>R$ ${Number(table.exchange).toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        })}</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;

    new bootstrap.Modal(
        document.getElementById("tablesPortModal")
    ).show();
}


async function getNewOperations(payload) {
  const token = localStorage.getItem('access')

  try {
    const response = await fetch(
      'https://expertconsig.pythonanywhere.com/api/v1/operations/new/',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          age: payload.age,
          installment: payload.installment,
          entity_code: payload.entity_code,
          illiterate: payload.illiterate,
          negative: payload.negative,
          user_room: payload.user_room,
          initial_date: payload.initial_date || null
        })
      }
    )

    const data = await response.json()

    if (!response.ok) {
      return {
        status: 'error',
        code: response.status,
        data
      }
    }

    return data

  } catch (error) {
    return {
      status: 'error',
      message: 'Erro ao conectar com o servidor'
    }
  }
}


async function getPortOperations(payload) {
  const token = localStorage.getItem('access')

  try {
    const response = await fetch(
      'https://expertconsig.pythonanywhere.com/api/v1/operations/',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            age: payload.age,
            entity_code: payload.entity_code,
            illiterate: payload.illiterate,
            negative: payload.negative,
            user_room: payload.user_room,
            initial_date: payload.initial_date || null,
            original_bank: payload.original_bank,
            rate: payload.taxa,
            original_terms: payload.prazo_original,
            remaining_terms: payload.prazo_restante,
            installment: payload.installment,
            ballance: payload.ballance
        })
      }
    )

    const data = await response.json()

    if (!response.ok) {
      return {
        status: 'error',
        code: response.status,
        data
      }
    }

    return data

  } catch (error) {
    return {
      status: 'error',
      message: 'Erro ao conectar com o servidor'
    }
  }
}

</script>

</body>
</html>
