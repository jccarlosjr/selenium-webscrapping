<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consulta por CPF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <style>
       .label {
            font-weight: 600;
            color: #555;
        }
        .value {
            font-weight: 500;
        }
        .bank-img{
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container my-5">

    <h3 class="mb-4">Consulta de Benefícios por CPF</h3>

    <div class="row mb-4">
        <div class="col-md-4">
            <input type="text" id="cpf" class="form-control" placeholder="Digite o CPF">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="consultar()">Consultar</button>
        </div>
    </div>

    <div id="status" class="mb-3"></div>

    <div id="resultado">

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>

window.addEventListener('load', async () => {
  await loginAndSaveToken()
})


async function loginAndSaveToken() {
  try {
    const response = await fetch(
      'https://expertconsig.pythonanywhere.com/api/v1/authentication/token/',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: 'scrapper',
          password: 'Vanguard@20'
        })
      }
    )

    const data = await response.json()

    if (!response.ok) {
      return {
        status: 'error',
        code: response.status,
        data
      }
    }

    localStorage.setItem('access', data.access)
    localStorage.setItem('refresh', data.refresh)

    return {
      status: 'success',
      access: data.access,
      refresh: data.refresh
    }

  } catch (error) {
    return {
      status: 'error',
      message: 'Erro ao conectar com o servidor'
    }
  }
}

function consultar() {
    const cpf = document.getElementById("cpf").value.trim();
    const status = document.getElementById("status");
    const resultado = document.getElementById("resultado");

    status.innerHTML = "";
    resultado.innerHTML = "";

    if (!cpf) {
        status.innerHTML = `<div class="alert alert-danger">Informe um CPF</div>`;
        return;
    }

    status.innerHTML = `
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    `;

    fetch("{% url 'scrapper' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ cpf })
    })
    .then(res => res.json())
    .then(data => {

        if (data.erro) {
            status.innerHTML = `<div class="alert alert-danger">${data.erro}</div>`;
            return;
        }

        status.innerHTML = `<div></div>`;
        renderResultado(data);
    })
    .catch(() => {
        status.innerHTML = `<div class="alert alert-danger">Erro ao consultar</div>`;
    });
}

function maskCPF(cpf) {
    const cpfNumbers = String(cpf).replace(/\D/g, '');

    const cpfPadded = cpfNumbers
        .padStart(11, '0')
        .slice(-11);

    return cpfPadded.replace(
        /(\d{3})(\d{3})(\d{3})(\d{2})/,
        '$1.$2.$3-$4'
    );
}


function maskCEP(cep) {
    const cepNumbers = String(cep).replace(/\D/g, '');

    const cepPadded = cepNumbers
        .padStart(8, '0')
        .slice(-8);

    return cepPadded.replace(
        /(\d{5})(\d{3})/,
        '$1-$2'
    );
}


function renderResultado(data) {
    let result = document.getElementById("resultado");
    result.innerHTML = "";

    data.forEach((element, index) => {
        let installmentHTML = "";
        let collapseId = `collapse-${index}`;

        if (element["empréstimos"] && element["empréstimos"].length) {
            element["empréstimos"].forEach(installment => {
                installmentHTML += renderInstallments(installment);
            });
        }

        html = `
            <div class="accordion-item rounded shadow-sm p-3 mt-2 bg-success-subtle">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#${collapseId}"
                        aria-expanded="false"
                        aria-controls="${collapseId}">
                        <div class="col-md-6">
                            <span class="label">Matrícula: ${element.nb_uf}</span>
                        </div>
                        <div class="col-md-6">
                            <span class="label" id="especie-${index}">${element.especie}</span>
                        </div>
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse mt-2 bg-light rounded">
                    <div class="row g-3 ms-2 mt-1 text-center">
                        <div class="col-md-4">
                            <label class="label">Nome</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.nome}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">CPF</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.cpf}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Nascimento</label>
                            <input class="text-muted form-control form-control-sm text-center" id="nascimento-${index}" disabled value="${element.nascimento}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Matrícula</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.nb_uf}" type="text">
                        </div>
                    </div>
                    <div class="row g-3 ms-2 mt-1 text-center">
                        <div class="col-md-2">
                            <label class="label">Situação</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.situacao_beneficio}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Data de Despacho</label>
                            <input class="text-muted form-control form-control-sm text-center" id="data_despacho-${index}" disabled value="${element.ddb}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Recebimento</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.meio_pagamento}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Salário</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.base_calculo}" type="text">
                        </div>
                        <div class="col-md-1">
                            <label class="label">Banco</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.banco}" type="text">
                        </div>
                        <div class="col-md-1">
                            <label class="label">Agência</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.agencia}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Conta</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.conta_corrente}" type="text">
                        </div>
                    </div>

                    <div class="row g-3 ms-2 text-center mt-2">
                        <div class="col-md-4">
                            <label class="label">Endereço</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.endereco}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">CEP</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${maskCEP(element.cep)}" type="text">
                        </div>
                        <div class="col-md-2">
                            <label class="label">Bairro</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.bairro}" type="text">
                        </div>
                        <div class="col-md-3">
                            <label class="label">Cidade UF</label>
                            <input class="text-muted form-control form-control-sm text-center" disabled value="${element.cidade_uf}" type="text">
                        </div>
                    </div>

                    <div class="row ms-1 me-1 mt-4">
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">Margem Livre</span> <span id="margem-${index}" class="text-muted">${element.margem_35}</span></div>
                                <div class="card-body" id="margem-div-${index}"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">RMC</span> <span id="rmc-${index}" class="text-muted">${element.margem_cartao}</span></div>
                                <div class="card-body" id="rmc-div-${index}"></div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card p-2">
                                <div class="card-head"><span class="label">RCC</span> <span id="rcc-${index}" class="text-muted">${element.cartao_beneficio}</span></div>
                                <div class="card-body" id="rcc-div-${index}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 m-1">
                        <div class="card">
                            <div class="card-header">
                                <div class="row text-center">
                                    <div class="col-2"><span class="label">Contrato</span></div>
                                    <div class="col-2"><span class="label">Banco</span></div>
                                    <div class="col-2"><span class="label">Parcela</span></div>
                                    <div class="col-2"><span class="label">Saldo</span></div>
                                    <div class="col-2"><span class="label">Prazo</span></div>
                                    <div class="col-2"><span class="label">Taxa</span></div>
                                </div>
                            </div>
                            <div class="card-body">
                                ${installmentHTML || "<div class='text-center text-muted'>Nenhum empréstimo</div>"}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
        `
        result.innerHTML += html;
    });
}


function renderInstallments(element){
    return `
    <div class="row text-center py-1">
        <div class="col-2"><small class="text-muted">${element.contrato}</small></div>
        <div class="col-2"><small class="text-muted"><span>${bankHandler(element.banco)}</span></small></div>
        <div class="col-2"><small class="text-muted">R$ <span>${element.parcela}</span></small></div>
        <div class="col-2"><small class="text-muted">R$ <span>${element.saldo_devedor}</span></small></div>
        <div class="col-2"><small class="text-muted"><span>${element.prazo}</span></small></div>
        <div class="col-2"><small class="text-muted"><span>${element.taxa}</span></small></div>
    </div>
    <div class="row text-center border-bottom py-1">
        row
    </div>
    `
}


function bankHandler(text){
    return text.split(":")[1].trim();
}


function ageHandler(text){
    return Number(text.split("-")[1].replace("anos", "").trim());
}

function convertToISODate(dateBR) {
  if (!dateBR) return null

  const [day, month, year] = dateBR.split('/')

  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`
}

function floatValueHandler(text){
    return Number(text.replace("R$", "").replace(".", "").replace(",", "."));
}

function entityHandler(text){
    return Number(text.split("-")[0].trim());
}

async function getMargemLivre(index){
    margemValue = document.getElementById(`margem-${index}`).textContent;
    divResult = document.getElementById(`margem-div-${index}`);

    payload = {
        age: ageHandler(document.getElementById(`nascimento-${index}`).value),
        installment: floatValueHandler(document.getElementById(`margem-${index}`).textContent),
        entity_code: entityHandler(document.getElementById(`especie-${index}`).textContent),
        illiterate: false,
        negative: false,
        user_room: 1,
        initial_date: convertToISODate(document.getElementById(`data_despacho-${index}`).value),
    }

    const response = await getNewOperations(payload);

    const banks = response.results;

    let html = `<div class="row g-2">`;

    banks.forEach(bank => {
        html += `
            <div class="col-12 col-md-6 col-lg-4">
                <img 
                    class="bank-img"
                    id="bank-${bank.bank}"
                    src="${bank.icon}" 
                    alt="${bank.bank_name}"
                    style="width: 48px; height: 48px; object-fit: contain; border-radius: 5px;"
                />
            </div>
        `;
    });

    html += `</div>`;
    divResult.innerHTML = html;
}


async function getNewOperations(payload) {
  const token = localStorage.getItem('access')

  try {
    const response = await fetch(
      'https://expertconsig.pythonanywhere.com/api/v1/operations/new/',
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          age: payload.age,
          installment: payload.installment,
          entity_code: payload.entity_code,
          illiterate: payload.illiterate,
          negative: payload.negative,
          user_room: payload.user_room,
          initial_date: payload.initial_date || null
        })
      }
    )

    const data = await response.json()

    if (!response.ok) {
      return {
        status: 'error',
        code: response.status,
        data
      }
    }

    return data

  } catch (error) {
    return {
      status: 'error',
      message: 'Erro ao conectar com o servidor'
    }
  }
}

</script>

</body>
</html>
